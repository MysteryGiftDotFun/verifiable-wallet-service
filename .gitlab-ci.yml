stages:
  - build
  - deploy

variables:
  # Configure these in GitLab CI/CD Variables
  # DOCKER_USERNAME
  # DOCKER_PASSWORD
  # PHALA_CLOUD_KEY
  # PHALA_APP_ID
  DOCKER_IMAGE: $DOCKER_USERNAME/verifiable-wallet-service

build_image:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  script:
    - cd worker
    - docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD
    - docker build -t $DOCKER_IMAGE:latest -t $DOCKER_IMAGE:$CI_COMMIT_SHA .
    - docker push $DOCKER_IMAGE:latest
    - docker push $DOCKER_IMAGE:$CI_COMMIT_SHA
  rules:
    - if: $CI_COMMIT_BRANCH == "main"

deploy_phala:
  stage: deploy
  image: node:20
  script:
    - npm install -g @phala/cli
    - cd worker
    # Authenticate via env var token (simulated login)
    # Note: Phala CLI might require interactive login or a specific token setup.
    # Assuming we can pass token or use a config file.
    # For now, we will assume manual deployment or use a custom script if CLI doesn't support non-interactive token.
    # But usually, CLIs have a token flag or env var.
    # Checking docs or assuming `npx phala login --token` or similar exists.
    # If not, we might need to write a config file.

    # Official docs check needed: For now using a placeholder logic.
    # Real Phala CLI uses `phala login` which opens browser.
    # For CI, we need an API Key or Token mechanism.

    # Assuming we can just upgrade if we have the right credentials in env.
    # If phala-cli doesn't support CI login easily, we might need a workaround.
    # For this task, I will output the standard approach.

    - echo "Deploying to Phala Cloud..."
    # Placeholder for actual non-interactive login
    # - npx phala login --token $PHALA_CLOUD_KEY

    # Use the upgrade command
    - npx phala cvms upgrade $PHALA_APP_ID --image $DOCKER_IMAGE:$CI_COMMIT_SHA
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
